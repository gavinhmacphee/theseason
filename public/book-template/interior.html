<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Team Season - Book Interior</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Instrument+Serif:ital@0;1&family=JetBrains+Mono:wght@400;500;600;700&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
  /* Lulu 7.75x7.75" square hardcover case wrap, 0.125" bleed on all edges
     Total page: 8in x 8in
     Safe area starts 0.3125in (bleed + safe margin) from each edge */
  @page {
    size: 8in 8in;
    margin: 0;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  :root {
    --team-color: #1B4332;
    --team-color-light: rgba(27, 67, 50, 0.12);
    --team-color-faint: rgba(27, 67, 50, 0.06);
    --text: #1A1A1A;
    --text-muted: #6B7280;
    --text-light: #9CA3AF;
    --bg: #FFFDF8;
    --win: #2D6A4F;
    --loss: #C1121F;
    --draw: #6B7280;
    --page-w: 8in;
    --page-h: 8in;
    --bleed: 0.125in;
    --safe: 0.1875in;
    --pad: 0.5in; /* bleed + safe + comfortable margin */
    --pad-top: 0.5in;
    --pad-bottom: 0.5in;
  }

  body {
    font-family: Georgia, 'Times New Roman', serif;
    color: var(--text);
    background: var(--bg);
    -webkit-font-smoothing: antialiased;
    -webkit-print-color-adjust: exact;
    print-color-adjust: exact;
  }

  .page {
    width: var(--page-w);
    height: var(--page-h);
    padding: var(--pad-top) var(--pad) var(--pad-bottom);
    position: relative;
    overflow: hidden;
    page-break-after: always;
    break-after: page;
    background: var(--bg);
  }

  .page:last-child {
    page-break-after: avoid;
    break-after: avoid;
  }

  .page-inner {
    width: 100%;
    height: 100%;
    position: relative;
  }

  .page-number {
    position: absolute;
    bottom: 0.4in;
    left: 0;
    right: 0;
    text-align: center;
    font-family: 'JetBrains Mono', monospace;
    font-size: 9px;
    color: var(--text-light);
    letter-spacing: 1px;
  }

  /* --- Title Page --- */
  .title-page {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    padding: 2in 1.25in;
  }

  .title-page .team-accent {
    width: 60px;
    height: 3px;
    background: var(--team-color);
    margin-bottom: 48px;
  }

  .title-page .team-name {
    font-family: 'Instrument Serif', Georgia, serif;
    font-size: 42px;
    font-weight: 400;
    line-height: 1.08;
    color: var(--text);
    margin-bottom: 16px;
    letter-spacing: -0.5px;
  }

  .title-page .player-name {
    font-family: 'DM Sans', sans-serif;
    font-size: 18px;
    font-weight: 400;
    color: var(--text-muted);
    margin-bottom: 10px;
  }

  .title-page .season-label {
    font-family: 'JetBrains Mono', monospace;
    font-size: 12px;
    color: var(--text-light);
    letter-spacing: 3px;
    text-transform: uppercase;
  }

  .title-page .team-accent-bottom {
    width: 60px;
    height: 3px;
    background: var(--team-color);
    margin-top: 48px;
  }

  /* --- Summary Page --- */
  .summary-page {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    padding: 1.5in 1.25in;
  }

  .summary-page .section-label {
    font-family: 'JetBrains Mono', monospace;
    font-size: 10px;
    color: var(--text-light);
    letter-spacing: 3px;
    text-transform: uppercase;
    margin-bottom: 40px;
  }

  .summary-page .record {
    font-family: 'JetBrains Mono', monospace;
    font-size: 52px;
    font-weight: 700;
    color: var(--text);
    letter-spacing: 4px;
    margin-bottom: 8px;
  }

  .summary-page .record-label {
    font-family: 'JetBrains Mono', monospace;
    font-size: 11px;
    color: var(--text-light);
    letter-spacing: 2px;
    text-transform: uppercase;
    margin-bottom: 48px;
  }

  .summary-page .stat-row {
    display: flex;
    gap: 56px;
    margin-bottom: 48px;
  }

  .summary-page .stat {
    text-align: center;
  }

  .summary-page .stat-value {
    font-family: 'JetBrains Mono', monospace;
    font-size: 26px;
    font-weight: 600;
    color: var(--text);
  }

  .summary-page .stat-label {
    font-family: 'DM Sans', sans-serif;
    font-size: 11px;
    color: var(--text-light);
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-top: 4px;
  }

  .summary-page .date-range {
    font-family: 'DM Sans', sans-serif;
    font-size: 15px;
    color: var(--text-muted);
  }

  .summary-divider {
    width: 40px;
    height: 2px;
    background: var(--team-color-light);
    margin: 0 auto 48px;
  }

  /* --- Entry Pages --- */
  .entry {
    margin-bottom: 0;
  }

  .entry + .entry {
    padding-top: 32px;
    margin-top: 32px;
    border-top: 1px solid var(--team-color-faint);
  }

  .entry-header {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    margin-bottom: 14px;
  }

  .entry-type {
    font-family: 'JetBrains Mono', monospace;
    font-size: 9px;
    font-weight: 500;
    color: var(--text-light);
    text-transform: uppercase;
    letter-spacing: 2px;
  }

  .entry-date {
    font-family: 'JetBrains Mono', monospace;
    font-size: 11px;
    color: var(--text-light);
  }

  .entry-score {
    display: flex;
    align-items: center;
    gap: 14px;
    margin-bottom: 16px;
  }

  .entry-score .score-num {
    font-family: 'JetBrains Mono', monospace;
    font-size: 32px;
    font-weight: 700;
    color: var(--text);
    letter-spacing: 2px;
  }

  .entry-score .result-badge {
    font-family: 'JetBrains Mono', monospace;
    font-size: 10px;
    font-weight: 600;
    padding: 3px 8px;
    border-radius: 3px;
    color: white;
    letter-spacing: 1px;
  }

  .result-badge.win { background: var(--win); }
  .result-badge.loss { background: var(--loss); }
  .result-badge.draw { background: var(--draw); }

  .entry-opponent {
    font-family: 'DM Sans', sans-serif;
    font-size: 14px;
    color: var(--text-muted);
    margin-bottom: 14px;
  }

  .entry-photo {
    width: 100%;
    max-height: 4.5in;
    object-fit: cover;
    border-radius: 4px;
    margin-bottom: 16px;
    display: block;
  }

  .entry-text {
    font-family: Georgia, 'Times New Roman', serif;
    font-style: italic;
    font-size: 16px;
    line-height: 1.7;
    color: #2A2A2A;
  }

  .entry-venue {
    font-family: 'DM Sans', sans-serif;
    font-size: 11px;
    color: var(--text-light);
    margin-top: 12px;
  }

  /* --- Text-only page (single entry, no photo) --- */
  .page.text-only-page {
    display: flex;
    flex-direction: column;
    justify-content: center;
    padding: 1in 0.75in;
  }

  .text-only-page .entry-text {
    font-size: 18px;
    line-height: 1.75;
  }

  .text-only-page .entry-score .score-num {
    font-size: 44px;
  }

  /* --- Photo page (entry with image) --- */
  .page.photo-page .entry-photo {
    max-height: 5in;
  }

  /* --- Closing Page --- */
  .closing-page {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    padding: 2in 1.5in;
  }

  .closing-page .closing-text {
    font-family: 'Instrument Serif', Georgia, serif;
    font-style: italic;
    font-size: 24px;
    line-height: 1.5;
    color: var(--text-muted);
    margin-bottom: 56px;
  }

  .closing-page .closing-accent {
    width: 40px;
    height: 2px;
    background: var(--team-color);
    margin-bottom: 28px;
  }

  .closing-page .brand {
    font-family: 'JetBrains Mono', monospace;
    font-size: 10px;
    color: var(--text-light);
    letter-spacing: 4px;
    text-transform: uppercase;
  }

  /* Print overrides */
  @media print {
    body { background: white; }
    .page { background: white; }
  }
</style>
</head>
<body>
<div id="book"></div>

<script>
// Fallback demo data (used when opened directly in browser)
const P = (id) => [
  "https://images.unsplash.com/photo-1574629810360-7efbbe195018?w=800&h=500&fit=crop",
  "https://images.unsplash.com/photo-1431324155629-1a6deb1dec8d?w=800&h=500&fit=crop",
  "https://images.unsplash.com/photo-1553778263-73a83bab9b0c?w=800&h=500&fit=crop",
  "https://images.unsplash.com/photo-1517466787929-bc90951d0974?w=800&h=500&fit=crop",
  "https://images.unsplash.com/photo-1560272564-c83b66b1ad12?w=800&h=500&fit=crop",
  "https://images.unsplash.com/photo-1551958219-acbc608c6377?w=800&h=500&fit=crop",
  "https://images.unsplash.com/photo-1579952363873-27f3bade9f55?w=800&h=500&fit=crop",
  "https://images.unsplash.com/photo-1606925797300-0b35e9d1794e?w=800&h=500&fit=crop",
][id % 8];
const DEMO_DATA = {
  team: { name: "Monta\u00f1a FC", emoji: "\u26BD", logo: null, color: "#1B4332" },
  season: { name: "Spring 2026" },
  players: [{ name: "Marco", headshot: null }],
  entries: [
    // --- February ---
    { id: "e1", entry_type: "game", text: "First game of the season. Nerves everywhere but he settled in after ten minutes. Won a header he had no business winning and the whole bench lost it.",
      entry_date: "2026-02-07", opponent: "FC Dynamo", score_home: 2, score_away: 1, result: "win",
      venue: "Memorial Field", photoData: null, photoPreview: P(0) },
    { id: "e2", entry_type: "practice", text: "New formation day. Coach moved him into the eight role and it just clicked. He was finding pockets of space nobody else saw. Even the older kids on the next field stopped to watch the scrimmage.",
      entry_date: "2026-02-09", opponent: null, score_home: null, score_away: null, result: null,
      venue: "Training Complex", photoData: null, photoPreview: null },
    { id: "e3", entry_type: "game", text: "Tough road loss. Their keeper was unreal but we also gave away two soft goals on set pieces. He played hard though. Won every fifty-fifty in the second half.",
      entry_date: "2026-02-14", opponent: "Rapids SC", score_home: 1, score_away: 3, result: "loss",
      venue: "Riverside Park", photoData: null, photoPreview: null },
    { id: "e4", entry_type: "moment", text: "Stayed after practice for an extra thirty minutes working on free kicks with his buddy Jalen. Just the two of them and a bag of balls. This is the stuff you remember.",
      entry_date: "2026-02-16", opponent: null, score_home: null, score_away: null, result: null,
      venue: null, photoData: null, photoPreview: P(1) },
    { id: "e5", entry_type: "game", text: "Hat trick. Three goals in eighteen minutes in the second half. The third one was a left-footed curler from outside the box that dipped right under the bar. Absolute screamer.",
      entry_date: "2026-02-21", opponent: "Lightning FC", score_home: 4, score_away: 0, result: "win",
      venue: "Home Field", photoData: null, photoPreview: P(2) },
    { id: "e6", entry_type: "practice", text: "Defensive shape session. He was not thrilled about tracking back but did the work without complaining. Growth.",
      entry_date: "2026-02-23", opponent: null, score_home: null, score_away: null, result: null,
      venue: "Training Complex", photoData: null, photoPreview: null },
    { id: "e7", entry_type: "game", text: "Back and forth the whole game. We went up, they equalized, we went up again, they equalized again. He was gassed by the seventy-fifth minute but gutted it out. Draw feels like a loss after being up twice.",
      entry_date: "2026-02-28", opponent: "Strikers United", score_home: 2, score_away: 2, result: "draw",
      venue: "Central Park", photoData: null, photoPreview: null },

    // --- March ---
    { id: "e8", entry_type: "game", text: "Shutout. Their forwards couldn't get past the back line and he controlled the midfield all game. Completed something like forty passes without a turnover.",
      entry_date: "2026-03-01", opponent: "Metro FC", score_home: 1, score_away: 0, result: "win",
      venue: "Home Field", photoData: null, photoPreview: P(3) },
    { id: "e9", entry_type: "practice", text: "Crossing and finishing drill. He put three perfect balls into the box from the right side. Coach said his delivery is the best on the team right now. The kid beamed.",
      entry_date: "2026-03-04", opponent: null, score_home: null, score_away: null, result: null,
      venue: "Training Complex", photoData: null, photoPreview: null },
    { id: "e10", entry_type: "game", text: "Rainy game on a waterlogged field. Nobody could keep their footing. He slid for a tackle in the box, won the ball clean, and launched a counterattack that led to the winner. Soaked and grinning ear to ear.",
      entry_date: "2026-03-07", opponent: "Wolves Academy", score_home: 2, score_away: 1, result: "win",
      venue: "Westside Complex", photoData: null, photoPreview: P(4) },
    { id: "e11", entry_type: "moment", text: "Team dinner at the pizza place after the Wolves win. Whole squad together, laughing, recapping goals. These are the nights they will talk about in ten years.",
      entry_date: "2026-03-07", opponent: null, score_home: null, score_away: null, result: null,
      venue: "Mario's Pizza", photoData: null, photoPreview: null },
    { id: "e12", entry_type: "practice", text: "Goalkeeper session with the whole team taking turns in net. He made three saves and let in about fifteen. Everybody was dying laughing. Good energy before the tournament weekend.",
      entry_date: "2026-03-11", opponent: null, score_home: null, score_away: null, result: null,
      venue: "Training Complex", photoData: null, photoPreview: P(5) },
    { id: "e13", entry_type: "tournament", text: "Spring Invitational opener. We came out flat and they punished us early. Fought back to 2-2 but couldn't find a third. Still advance on goal difference.",
      entry_date: "2026-03-14", opponent: "Coastal United", score_home: 2, score_away: 2, result: "draw",
      venue: "Spring Invitational", photoData: null, photoPreview: null },
    { id: "e14", entry_type: "tournament", text: "Second group game. He scored from the spot after getting fouled in the box. Cool as you like. Sent the keeper the wrong way. We controlled the whole second half.",
      entry_date: "2026-03-14", opponent: "Bay Area SC", score_home: 3, score_away: 1, result: "win",
      venue: "Spring Invitational", photoData: null, photoPreview: P(6) },
    { id: "e15", entry_type: "tournament", text: "Semifinal. Best game of the season so far. End to end, physical, intense. He won a header at the back post in the eighty-eighth minute. Pandemonium. The whole sideline rushed the field.",
      entry_date: "2026-03-15", opponent: "Vipers Elite", score_home: 2, score_away: 1, result: "win",
      venue: "Spring Invitational", photoData: null, photoPreview: P(7) },
    { id: "e16", entry_type: "tournament", text: "Championship final. We left everything on the field. Lost on penalties after a scoreless draw. He buried his penalty but two teammates missed. He hugged them both after. Proud of this team.",
      entry_date: "2026-03-15", opponent: "Legends FC", score_home: 0, score_away: 0, result: "loss",
      venue: "Spring Invitational", photoData: null, photoPreview: P(0) },
    { id: "e17", entry_type: "practice", text: "Recovery session after the tournament. Light jog, stretching, small-sided games. He was still replaying the final in his head. You could see it in his eyes.",
      entry_date: "2026-03-18", opponent: null, score_home: null, score_away: null, result: null,
      venue: "Training Complex", photoData: null, photoPreview: null },
    { id: "e18", entry_type: "game", text: "Bounce-back win. Came out with something to prove after the tournament loss. He was everywhere. Two goals, an assist, and a perfectly timed block on a goal-bound shot.",
      entry_date: "2026-03-21", opponent: "Phoenix Rising", score_home: 4, score_away: 1, result: "win",
      venue: "Home Field", photoData: null, photoPreview: P(1) },
    { id: "e19", entry_type: "game", text: "Close road game. We sat deep and tried to hit them on the counter. It almost worked. They scored a late free kick to win it. Frustrating but the defensive effort was solid.",
      entry_date: "2026-03-28", opponent: "Atlas Academy", score_home: 0, score_away: 1, result: "loss",
      venue: "Atlas Sports Park", photoData: null, photoPreview: null },

    // --- April ---
    { id: "e20", entry_type: "practice", text: "Fitness testing day. He ran the fastest beep test on the squad and then immediately went to the water cooler and pretended to pass out. Classic Marco.",
      entry_date: "2026-04-01", opponent: null, score_home: null, score_away: null, result: null,
      venue: "Training Complex", photoData: null, photoPreview: null },
    { id: "e21", entry_type: "game", text: "Dominated from start to finish. He dropped deep to collect the ball and sprayed passes everywhere. Looked like a completely different player than the start of the season. The development is real.",
      entry_date: "2026-04-04", opponent: "FC Dynamo", score_home: 3, score_away: 0, result: "win",
      venue: "Memorial Field", photoData: null, photoPreview: P(2) },
    { id: "e22", entry_type: "moment", text: "Car ride home after the Dynamo game. He was quiet for a while and then said he thinks this is his best season ever. No prompting, just said it. Sometimes you just listen.",
      entry_date: "2026-04-04", opponent: null, score_home: null, score_away: null, result: null,
      venue: null, photoData: null, photoPreview: null },
    { id: "e23", entry_type: "game", text: "Rematch against Rapids. This time we were ready. He marked their best player out of the game and still found time to get forward. Complete performance.",
      entry_date: "2026-04-11", opponent: "Rapids SC", score_home: 2, score_away: 0, result: "win",
      venue: "Riverside Park", photoData: null, photoPreview: null },
    { id: "e24", entry_type: "practice", text: "Small-sided tournament within the team. His squad won the whole thing. He was talking trash the entire time. The coaches were laughing. The other kids were not.",
      entry_date: "2026-04-13", opponent: null, score_home: null, score_away: null, result: null,
      venue: "Training Complex", photoData: null, photoPreview: P(3) },
    { id: "e25", entry_type: "game", text: "Wild game. Up 3-1, almost blew it, held on 3-2. He scored the third goal and then spent the last twenty minutes defending for his life. Heart was in my throat the whole time.",
      entry_date: "2026-04-18", opponent: "Strikers United", score_home: 3, score_away: 2, result: "win",
      venue: "Home Field", photoData: null, photoPreview: P(4) },
    { id: "e26", entry_type: "practice", text: "Set piece rehearsal. Corners, free kicks, throw-in routines. He was on delivery duty and got annoyed when the timing was off. Leadership showing up in small ways.",
      entry_date: "2026-04-20", opponent: null, score_home: null, score_away: null, result: null,
      venue: "Training Complex", photoData: null, photoPreview: null },
    { id: "e27", entry_type: "game", text: "Scoreless draw against a very good team. Nobody creates anything. Physical, chippy, hard. A point on the road against these guys is a good result. He got a yellow for a late challenge and was furious with himself.",
      entry_date: "2026-04-25", opponent: "Metro FC", score_home: 0, score_away: 0, result: "draw",
      venue: "Metro Stadium", photoData: null, photoPreview: null },
    { id: "e28", entry_type: "moment", text: "Found him in the backyard after dinner juggling in the dark. Just the sound of the ball and the crickets. Didn't say anything. Just watched from the window.",
      entry_date: "2026-04-27", opponent: null, score_home: null, score_away: null, result: null,
      venue: null, photoData: null, photoPreview: P(5) },

    // --- May ---
    { id: "e29", entry_type: "game", text: "Senior night for the older players. Emotional pregame ceremony. He played inspired. Two assists, both to seniors. That kind of awareness does not show up on a stat sheet.",
      entry_date: "2026-05-02", opponent: "Wolves Academy", score_home: 3, score_away: 1, result: "win",
      venue: "Home Field", photoData: null, photoPreview: P(6) },
    { id: "e30", entry_type: "practice", text: "Last real training session before playoffs. Intensity was through the roof. He got into a shouting match with his buddy over a foul call in the scrimmage. They were best friends again five minutes later.",
      entry_date: "2026-05-05", opponent: null, score_home: null, score_away: null, result: null,
      venue: "Training Complex", photoData: null, photoPreview: null },
    { id: "e31", entry_type: "game", text: "Regular season finale. Nothing on the line standings-wise but he played like it was a cup final. Coaches rested him at halftime and he looked personally offended. Wanted every minute.",
      entry_date: "2026-05-09", opponent: "Phoenix Rising", score_home: 2, score_away: 0, result: "win",
      venue: "Phoenix Sports Center", photoData: null, photoPreview: null },
    { id: "e32", entry_type: "tournament", text: "State Cup first round. Nerves from both teams. Sloppy first half. He calmed everyone down at the break and we came out sharp. Two quick goals and the game was over.",
      entry_date: "2026-05-16", opponent: "Valley FC", score_home: 3, score_away: 0, result: "win",
      venue: "State Cup - Round 1", photoData: null, photoPreview: P(7) },
    { id: "e33", entry_type: "practice", text: "Film session at coach's house. Watching tape of the next opponent. He was pointing out defensive patterns before the coaches did. His soccer brain has leveled up this season.",
      entry_date: "2026-05-18", opponent: null, score_home: null, score_away: null, result: null,
      venue: "Coach's House", photoData: null, photoPreview: null },
    { id: "e34", entry_type: "tournament", text: "State Cup quarterfinal. Tight, tense, tactical. One goal separated us. He made a goal-line clearance in the seventy-second minute that saved the season. The kind of play you replay in your head forever.",
      entry_date: "2026-05-23", opponent: "Summit SC", score_home: 1, score_away: 0, result: "win",
      venue: "State Cup - Quarterfinal", photoData: null, photoPreview: P(0) },
    { id: "e35", entry_type: "moment", text: "Team pool party the day before the semifinal. Cannonball contest. He won, obviously. Sometimes you need to remember they are still just kids having the time of their lives.",
      entry_date: "2026-05-28", opponent: null, score_home: null, score_away: null, result: null,
      venue: "The Hendersons' Pool", photoData: null, photoPreview: null },
    { id: "e36", entry_type: "tournament", text: "State Cup semifinal. We went down early and I thought it was over. He pulled the team together, demanded the ball, and dragged us back into it. Equalized in the sixty-fifth minute with a volley from the edge of the box. Won in extra time. Tears on the sideline.",
      entry_date: "2026-05-30", opponent: "Coastal United", score_home: 3, score_away: 2, result: "win",
      venue: "State Cup - Semifinal", photoData: null, photoPreview: P(1) },
    { id: "e37", entry_type: "practice", text: "Light session before the final. Passing drills, team talk, group photo. Coach told them win or lose, this has been the best season he has coached. Everyone believed it.",
      entry_date: "2026-06-01", opponent: null, score_home: null, score_away: null, result: null,
      venue: "Training Complex", photoData: null, photoPreview: P(2) },
    { id: "e38", entry_type: "moment", text: "Night before the final. He set out his kit on the chair by his bed like he always does. Boots cleaned, shin guards stacked, socks folded. A ritual since he was six years old. Some things never change.",
      entry_date: "2026-06-02", opponent: null, score_home: null, score_away: null, result: null,
      venue: null, photoData: null, photoPreview: null },
    { id: "e39", entry_type: "tournament", text: "State Cup Final. The biggest game of his life. Sold-out bleachers, announcer, the whole thing. He was nervous in warm-ups but the second the whistle blew he was locked in. Scored the opener from a corner. They equalized before half. He set up the winner with a perfectly weighted through ball in the seventy-eighth minute. When the final whistle blew he dropped to his knees. I have never seen him that happy. Champions.",
      entry_date: "2026-06-03", opponent: "Legends FC", score_home: 2, score_away: 1, result: "win",
      venue: "State Cup - Final", photoData: null, photoPreview: P(3) },
    { id: "e40", entry_type: "moment", text: "Trophy ceremony. Medal around his neck. Holding the cup with his teammates. Biggest smile I have ever seen. This is what it is all about. Every early morning, every long drive, every rain-soaked Tuesday practice. Worth it. All of it.",
      entry_date: "2026-06-03", opponent: null, score_home: null, score_away: null, result: null,
      venue: "State Cup - Final", photoData: null, photoPreview: P(4) },
  ]
};

// --- Pagination (mirrors App.jsx logic, adjusted for 7.75x7.75" square) ---
function paginateEntries(entries) {
  // 7.75x7.75" square at ~260 PPI = ~2080px, minus ~580px padding = ~1500px
  const PAGE_BUDGET = 1500;
  const DIVIDER = 56;

  function estimateHeight(entry) {
    let h = 70; // header (type + date)
    if ((entry.entry_type === "game" || entry.entry_type === "tournament") &&
        entry.score_home !== null && entry.score_away !== null) {
      h += 90; // score block
    }
    if (entry.opponent) h += 40;
    if (entry.photoPreview || entry.photoData) h += 750; // photo (smaller on square page)
    if (entry.text) h += Math.ceil(entry.text.length / 40) * 50; // narrower page = fewer chars per line
    if (entry.venue) h += 38;
    return h;
  }

  const sorted = [...entries].sort((a, b) => new Date(a.entry_date) - new Date(b.entry_date));
  const pages = [];
  let currentPage = [];
  let currentHeight = 0;

  for (const entry of sorted) {
    const h = estimateHeight(entry);
    const hasPhoto = !!(entry.photoPreview || entry.photoData);

    // Photos get their own page
    if (hasPhoto) {
      if (currentPage.length > 0) {
        pages.push(currentPage);
        currentPage = [];
        currentHeight = 0;
      }
      pages.push([entry]);
      continue;
    }

    const needed = currentHeight > 0 ? h + DIVIDER : h;
    if (currentHeight + needed > PAGE_BUDGET && currentPage.length > 0) {
      pages.push(currentPage);
      currentPage = [entry];
      currentHeight = h;
    } else {
      currentPage.push(entry);
      currentHeight += needed;
    }
  }

  if (currentPage.length > 0) {
    pages.push(currentPage);
  }

  return pages;
}

// --- Rendering ---
function formatDate(dateStr) {
  const d = new Date(dateStr + 'T12:00:00');
  return d.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
}

function formatDateRange(entries) {
  const sorted = [...entries].sort((a, b) => new Date(a.entry_date) - new Date(b.entry_date));
  if (sorted.length === 0) return '';
  const first = new Date(sorted[0].entry_date + 'T12:00:00');
  const last = new Date(sorted[sorted.length - 1].entry_date + 'T12:00:00');
  const opts = { month: 'long', day: 'numeric', year: 'numeric' };
  return `${first.toLocaleDateString('en-US', opts)} \u2013 ${last.toLocaleDateString('en-US', opts)}`;
}

function esc(str) {
  if (!str) return '';
  const d = document.createElement('div');
  d.textContent = str;
  return d.innerHTML;
}

function renderBook(data) {
  const { team, season, players, entries } = data;
  const playerName = players[0]?.name || '';
  const teamColor = team.color || '#1B4332';

  // Set CSS custom properties for team color
  document.documentElement.style.setProperty('--team-color', teamColor);
  // Use hex + alpha for light/faint variants
  document.documentElement.style.setProperty('--team-color-light', teamColor + '1F');
  document.documentElement.style.setProperty('--team-color-faint', teamColor + '0F');

  const sorted = [...entries].sort((a, b) => new Date(a.entry_date) - new Date(b.entry_date));
  const games = sorted.filter(e => e.entry_type === 'game' || e.entry_type === 'tournament');
  const wins = games.filter(e => e.result === 'win').length;
  const losses = games.filter(e => e.result === 'loss').length;
  const draws = games.filter(e => e.result === 'draw').length;
  const practices = sorted.filter(e => e.entry_type === 'practice').length;
  const tournaments = sorted.filter(e => e.entry_type === 'tournament').length;

  const entryPages = paginateEntries(entries);
  let pageNum = 0;
  let html = '';

  // --- Title Page ---
  pageNum++;
  html += `
    <div class="page title-page">
      <div class="team-accent"></div>
      <div class="team-name">${esc(team.name)}</div>
      ${playerName ? `<div class="player-name">${esc(playerName)}</div>` : ''}
      <div class="season-label">${esc(season.name)}</div>
      <div class="team-accent-bottom"></div>
    </div>
  `;

  // --- Summary Page ---
  pageNum++;
  html += `
    <div class="page summary-page">
      <div class="section-label">Season Summary</div>
      <div class="record">${wins}-${losses}-${draws}</div>
      <div class="record-label">Win \u2013 Loss \u2013 Draw</div>
      <div class="summary-divider"></div>
      <div class="stat-row">
        <div class="stat">
          <div class="stat-value">${games.length}</div>
          <div class="stat-label">Games</div>
        </div>
        <div class="stat">
          <div class="stat-value">${practices}</div>
          <div class="stat-label">Practices</div>
        </div>
        ${tournaments > 0 ? `
        <div class="stat">
          <div class="stat-value">${tournaments}</div>
          <div class="stat-label">Tournaments</div>
        </div>` : ''}
        <div class="stat">
          <div class="stat-value">${sorted.length}</div>
          <div class="stat-label">Entries</div>
        </div>
      </div>
      <div class="date-range">${formatDateRange(sorted)}</div>
      <div class="page-number">${pageNum}</div>
    </div>
  `;

  // --- Entry Pages ---
  for (const pageEntries of entryPages) {
    pageNum++;
    let entriesHtml = '';
    for (const entry of pageEntries) {
      const hasScore = entry.score_home !== null && entry.score_away !== null;
      const photo = entry.photoData || entry.photoPreview;
      const resultClass = entry.result || '';
      const resultLabel = { win: 'W', loss: 'L', draw: 'D' }[entry.result] || '';

      entriesHtml += `
        <div class="entry">
          <div class="entry-header">
            <span class="entry-type">${esc(entry.entry_type)}</span>
            <span class="entry-date">${formatDate(entry.entry_date)}</span>
          </div>
          ${hasScore ? `
          <div class="entry-score">
            <span class="score-num">${entry.score_home} \u2013 ${entry.score_away}</span>
            ${resultLabel ? `<span class="result-badge ${resultClass}">${resultLabel}</span>` : ''}
          </div>` : ''}
          ${entry.opponent ? `<div class="entry-opponent">vs ${esc(entry.opponent)}</div>` : ''}
          ${photo ? `<img class="entry-photo" src="${photo}" alt="">` : ''}
          ${entry.text ? `<div class="entry-text">\u201C${esc(entry.text)}\u201D</div>` : ''}
          ${entry.venue ? `<div class="entry-venue">${esc(entry.venue)}</div>` : ''}
        </div>
      `;
    }

    const hasAnyPhoto = pageEntries.some(e => e.photoData || e.photoPreview);
    const isTextOnly = pageEntries.length === 1 && !hasAnyPhoto;

    html += `
      <div class="page${isTextOnly ? ' text-only-page' : ''}${hasAnyPhoto ? ' photo-page' : ''}">
        ${entriesHtml}
        <div class="page-number">${pageNum}</div>
      </div>
    `;
  }

  // --- Closing Page ---
  pageNum++;
  const closingName = playerName || 'yours';
  html += `
    <div class="page closing-page">
      <div class="closing-text">
        Every season tells a story.<br>
        This was ${esc(closingName)}'s.
      </div>
      <div class="closing-accent"></div>
      <div class="brand">Team Season</div>
    </div>
  `;

  document.getElementById('book').innerHTML = html;
}

// --- Init ---
async function init() {
  await document.fonts.ready;

  // Use injected data or fallback to demo
  const data = window.__BOOK_DATA__ || DEMO_DATA;
  renderBook(data);

  // Listen for late data injection (from parent window)
  window.addEventListener('bookDataReady', () => {
    if (window.__BOOK_DATA__) {
      renderBook(window.__BOOK_DATA__);
    }
  });
}

if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', init);
} else {
  init();
}
</script>
</body>
</html>
